# H∆∞·ªõng d·∫´n Setup Google Cloud Vertex AI cho Sportify

## üìã T·ªïng quan
Document n√†y h∆∞·ªõng d·∫´n chi ti·∫øt c√°ch c·∫•u h√¨nh Google Cloud Vertex AI ƒë·ªÉ thay th·∫ø Google Generative AI (Gemini REST API) trong ·ª©ng d·ª•ng Sportify.

## üéØ L·ª£i √≠ch c·ªßa Vertex AI
- ‚úÖ T√≠ch h·ª£p ch·∫∑t ch·∫Ω v·ªõi Google Cloud
- ‚úÖ H·ªó tr·ª£ nhi·ªÅu model AI (Gemini, PaLM, Claude...)
- ‚úÖ Qu·∫£n l√Ω API key v√† authentication t·ªët h∆°n
- ‚úÖ Scaling v√† performance t·ªët h∆°n
- ‚úÖ T√≠ch h·ª£p v·ªõi Google Cloud Console

---

## üöÄ B∆∞·ªõc 1: T·∫°o Google Cloud Project

### 1.1. ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p Google Cloud
1. Truy c·∫≠p: https://console.cloud.google.com/
2. ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google c·ªßa b·∫°n
3. N·∫øu ch∆∞a c√≥, k√≠ch ho·∫°t **Free Trial** ($300 credit trong 90 ng√†y)

### 1.2. T·∫°o Project m·ªõi
1. Click v√†o dropdown **Select a project** ·ªü g√≥c tr√™n b√™n tr√°i
2. Click **NEW PROJECT**
3. Nh·∫≠p th√¥ng tin:
   - **Project name**: `sportify-ai` (ho·∫∑c t√™n b·∫°n mu·ªën)
   - **Organization**: ƒê·ªÉ m·∫∑c ƒë·ªãnh (No organization)
4. Click **CREATE**
5. **L∆∞u l·∫°i PROJECT_ID** (th∆∞·ªùng c√≥ d·∫°ng: `sportify-ai-123456`)

---

## üîß B∆∞·ªõc 2: K√≠ch ho·∫°t Vertex AI API

### 2.1. Enable Vertex AI API
1. Trong Google Cloud Console, t√¨m ki·∫øm **"Vertex AI API"**
2. Ho·∫∑c truy c·∫≠p: https://console.cloud.google.com/apis/library/aiplatform.googleapis.com
3. Click **ENABLE**
4. ƒê·ª£i v√†i gi√¢y ƒë·ªÉ API ƒë∆∞·ª£c k√≠ch ho·∫°t

### 2.2. Enable Generative AI API (n·∫øu c·∫ßn)
1. T√¨m ki·∫øm **"Generative Language API"**
2. Click **ENABLE**

---

## üîë B∆∞·ªõc 3: T·∫°o Service Account v√† Authentication

### 3.1. T·∫°o Service Account
1. Trong Google Cloud Console, v√†o **IAM & Admin** ‚Üí **Service Accounts**
2. Ho·∫∑c truy c·∫≠p: https://console.cloud.google.com/iam-admin/serviceaccounts
3. Click **CREATE SERVICE ACCOUNT**
4. Nh·∫≠p th√¥ng tin:
   - **Service account name**: `sportify-vertex-ai`
   - **Service account ID**: T·ª± ƒë·ªông generate
   - **Description**: "Service account for Sportify Vertex AI"
5. Click **CREATE AND CONTINUE**

### 3.2. G√°n quy·ªÅn cho Service Account
Ch·ªçn c√°c role sau:
- ‚úÖ **Vertex AI User** (`roles/aiplatform.user`)
- ‚úÖ **Service Account User** (`roles/iam.serviceAccountUser`)

Click **CONTINUE** ‚Üí **DONE**

### 3.3. T·∫°o JSON Key
1. Trong danh s√°ch Service Accounts, click v√†o service account v·ª´a t·∫°o
2. Ch·ªçn tab **KEYS**
3. Click **ADD KEY** ‚Üí **Create new key**
4. Ch·ªçn **JSON**
5. Click **CREATE**
6. File JSON s·∫Ω ƒë∆∞·ª£c t·∫£i v·ªÅ m√°y (v√≠ d·ª•: `sportify-ai-123456-abc123def456.json`)
7. **‚ö†Ô∏è B·∫¢O M·∫¨T FILE N√ÄY - ƒê·ª™NG COMMIT L√äN GIT!**

---

## üíª B∆∞·ªõc 4: C·∫•u h√¨nh trong ·ª©ng d·ª•ng Spring Boot

### 4.1. L∆∞u Service Account JSON Key
1. Copy file JSON key ƒë√£ t·∫£i v·ªÅ v√†o th∆∞ m·ª•c project:
   ```
   SportifyBackend/
     ‚îú‚îÄ‚îÄ src/
     ‚îú‚îÄ‚îÄ credentials/
     ‚îÇ   ‚îî‚îÄ‚îÄ vertex-ai-key.json   ‚Üê ƒê·∫∑t file ·ªü ƒë√¢y
     ‚îî‚îÄ‚îÄ pom.xml
   ```

2. **Quan tr·ªçng**: Th√™m v√†o `.gitignore`:
   ```gitignore
   # Vertex AI Credentials
   credentials/
   *-key.json
   vertex-ai-key.json
   ```

### 4.2. C·∫•u h√¨nh Environment Variable
**C√°ch 1: Set trong System Environment (Khuy·∫øn ngh·ªã)**
```bash
# Windows PowerShell
$env:GOOGLE_APPLICATION_CREDENTIALS="D:\Doan\Khoa_Luan_Tot_Nghiep\SportifyBackend\credentials\vertex-ai-key.json"

# Windows CMD
set GOOGLE_APPLICATION_CREDENTIALS=D:\Doan\Khoa_Luan_Tot_Nghiep\SportifyBackend\credentials\vertex-ai-key.json

# Linux/Mac
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/sportify-backend/credentials/vertex-ai-key.json"
```

**C√°ch 2: Set trong IntelliJ IDEA / Eclipse**
- **IntelliJ**: Run ‚Üí Edit Configurations ‚Üí Environment Variables
  ```
  GOOGLE_APPLICATION_CREDENTIALS=D:\Doan\Khoa_Luan_Tot_Nghiep\SportifyBackend\credentials\vertex-ai-key.json
  ```

**C√°ch 3: Set trong application.properties (Kh√¥ng khuy·∫øn ngh·ªã - k√©m b·∫£o m·∫≠t)**
```properties
# KH√îNG N√äN l√†m c√°ch n√†y v√¨ d·ªÖ b·ªã l·ªô credentials
google.application.credentials=D:/Doan/Khoa_Luan_Tot_Nghiep/SportifyBackend/credentials/vertex-ai-key.json
```

### 4.3. C·∫≠p nh·∫≠t application.properties
M·ªü file `src/main/resources/application.properties` v√† c·∫≠p nh·∫≠t:

```properties
# ƒê·ªïi provider t·ª´ gemini sang vertex
ai.provider=vertex

# Vertex AI Configuration
vertex.ai.project.id=sportify-ai-123456  # ‚Üê Thay b·∫±ng PROJECT_ID c·ªßa b·∫°n
vertex.ai.location=us-central1           # Ho·∫∑c: asia-southeast1, europe-west4
vertex.ai.model=gemini-2.0-flash-exp     # Ho·∫∑c: gemini-1.5-pro, gemini-1.5-flash

# Optional: Custom endpoint (th∆∞·ªùng kh√¥ng c·∫ßn)
# vertex.ai.endpoint=us-central1-aiplatform.googleapis.com
```

**L·∫•y PROJECT_ID:**
- V√†o Google Cloud Console
- Click dropdown project ·ªü g√≥c tr√™n
- Copy **Project ID** (kh√¥ng ph·∫£i Project Name)

**Ch·ªçn Location (Region):**
- `us-central1`: M·ªπ (m·∫∑c ƒë·ªãnh)
- `asia-southeast1`: Singapore (g·∫ßn Vi·ªát Nam h∆°n, latency th·∫•p h∆°n)
- `europe-west4`: Ch√¢u √Çu

**Ch·ªçn Model:**
- `gemini-2.0-flash-exp`: Nhanh nh·∫•t, m·ªõi nh·∫•t (experimental)
- `gemini-1.5-flash`: Nhanh, ·ªïn ƒë·ªãnh
- `gemini-1.5-pro`: M·∫°nh nh·∫•t, ch·∫≠m h∆°n
- `gemini-2.5-pro`: Version m·ªõi nh·∫•t c·ªßa Pro

---

## üî® B∆∞·ªõc 5: Build v√† Test

### 5.1. Build Maven Project
```bash
# T·∫°i th∆∞ m·ª•c SportifyBackend
mvn clean install
```

### 5.2. Ch·∫°y ·ª©ng d·ª•ng
```bash
mvn spring-boot:run
```

### 5.3. Test API
D√πng Postman ho·∫∑c curl:

```bash
curl -X POST http://localhost:8081/sportify/rest/ai/analyze \
  -H "Content-Type: application/json" \
  -d '{"message": "T√¥i mu·ªën ƒë·∫∑t s√¢n b√≥ng ƒë√°", "provider": "vertex"}'
```

Ho·∫∑c test trong frontend (AIChatbox):
1. M·ªü trang ch·ªß
2. Click v√†o icon chat AI
3. G·ª≠i tin nh·∫Øn: "Ch√†o b·∫°n, t√¥i c·∫ßn t√¨m s√¢n b√≥ng"

---

## üêõ Troubleshooting

### ‚ùå L·ªói: "VERTEX_AI_PROJECT_ID ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh"
**Nguy√™n nh√¢n**: Ch∆∞a set `vertex.ai.project.id` trong `application.properties`

**Gi·∫£i ph√°p**: 
```properties
vertex.ai.project.id=YOUR_ACTUAL_PROJECT_ID
```

---

### ‚ùå L·ªói: "The Application Default Credentials are not available"
**Nguy√™n nh√¢n**: Ch∆∞a set environment variable `GOOGLE_APPLICATION_CREDENTIALS`

**Gi·∫£i ph√°p**:
```bash
# Windows PowerShell
$env:GOOGLE_APPLICATION_CREDENTIALS="D:\Doan\Khoa_Luan_Tot_Nghiep\SportifyBackend\credentials\vertex-ai-key.json"

# Sau ƒë√≥ restart IDE/terminal
```

---

### ‚ùå L·ªói: "Permission denied" ho·∫∑c "403 Forbidden"
**Nguy√™n nh√¢n**: Service account kh√¥ng c√≥ quy·ªÅn

**Gi·∫£i ph√°p**:
1. V√†o IAM & Admin ‚Üí Service Accounts
2. Click v√†o service account
3. Click tab **PERMISSIONS**
4. Th√™m role: **Vertex AI User**

---

### ‚ùå L·ªói: "Model not found" ho·∫∑c "Invalid model name"
**Nguy√™n nh√¢n**: Model kh√¥ng t·ªìn t·∫°i ho·∫∑c ch∆∞a available ·ªü region

**Gi·∫£i ph√°p**:
1. Ki·ªÉm tra model name: https://cloud.google.com/vertex-ai/generative-ai/docs/learn/models
2. Th·ª≠ ƒë·ªïi sang `gemini-1.5-flash` (stable version)
3. Ki·ªÉm tra region c√≥ h·ªó tr·ª£ model kh√¥ng

---

### ‚ùå L·ªói: Timeout ho·∫∑c slow response
**Nguy√™n nh√¢n**: Region xa ho·∫∑c network ch·∫≠m

**Gi·∫£i ph√°p**:
- ƒê·ªïi `vertex.ai.location` sang region g·∫ßn h∆°n (v√≠ d·ª•: `asia-southeast1`)
- TƒÉng timeout trong code (n·∫øu c·∫ßn)

---

## üí∞ Chi ph√≠ s·ª≠ d·ª•ng

### Free Tier (Mi·ªÖn ph√≠)
Google Cloud cung c·∫•p:
- ‚úÖ $300 credit trong 90 ng√†y ƒë·∫ßu (Free Trial)
- ‚úÖ Vertex AI c√≥ quota mi·ªÖn ph√≠ h√†ng th√°ng cho m·ªôt s·ªë model

### Gi√° sau Free Trial
- **Gemini 1.5 Flash**: ~$0.0005/1K characters input, ~$0.0015/1K characters output
- **Gemini 1.5 Pro**: ~$0.0035/1K characters input, ~$0.0105/1K characters output

**∆Ø·ªõc t√≠nh cho Sportify:**
- 1000 tin nh·∫Øn/ng√†y √ó 100 k√Ω t·ª±/tin = ~100K characters/ng√†y
- Chi ph√≠: ~$0.15-0.50/ng√†y (~$5-15/th√°ng)

---

## üìä So s√°nh: Gemini REST API vs Vertex AI

| Ti√™u ch√≠ | Gemini REST API | Vertex AI |
|----------|-----------------|-----------|
| **Setup** | D·ªÖ (ch·ªâ c·∫ßn API key) | Ph·ª©c t·∫°p h∆°n (c·∫ßn GCP project) |
| **B·∫£o m·∫≠t** | K√©m (API key d·ªÖ b·ªã l·ªô) | T·ªët (Service account, IAM) |
| **Scaling** | Gi·ªõi h·∫°n | Kh√¥ng gi·ªõi h·∫°n |
| **Monitoring** | Kh√¥ng c√≥ | Cloud Console ƒë·∫ßy ƒë·ªß |
| **Chi ph√≠** | Free (c√≥ quota) | Free trial ‚Üí Pay as you go |
| **Production** | ‚ùå Kh√¥ng khuy·∫øn ngh·ªã | ‚úÖ Khuy·∫øn ngh·ªã |

---

## üîÑ Switch gi·ªØa c√°c provider

B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng switch gi·ªØa OpenAI, Gemini REST API, v√† Vertex AI:

```properties
# Ch·ªçn 1 trong 3:
ai.provider=openai     # D√πng OpenAI GPT
ai.provider=gemini     # D√πng Gemini REST API
ai.provider=vertex     # D√πng Vertex AI (khuy·∫øn ngh·ªã)
```

Ho·∫∑c g·ª≠i trong request:
```json
{
  "message": "T√¥i mu·ªën ƒë·∫∑t s√¢n",
  "provider": "vertex"
}
```

---

## üìö T√†i li·ªáu tham kh·∫£o

- **Vertex AI Documentation**: https://cloud.google.com/vertex-ai/docs
- **Generative AI on Vertex AI**: https://cloud.google.com/vertex-ai/generative-ai/docs
- **Gemini Models**: https://cloud.google.com/vertex-ai/generative-ai/docs/learn/models
- **Java Client Library**: https://cloud.google.com/java/docs/reference/google-cloud-aiplatform/latest/overview
- **Pricing**: https://cloud.google.com/vertex-ai/pricing

---

## ‚úÖ Checklist Setup

- [ ] T·∫°o Google Cloud Project
- [ ] Enable Vertex AI API
- [ ] T·∫°o Service Account v·ªõi role "Vertex AI User"
- [ ] Download JSON key v√† l∆∞u v√†o `credentials/`
- [ ] Th√™m `credentials/` v√†o `.gitignore`
- [ ] Set environment variable `GOOGLE_APPLICATION_CREDENTIALS`
- [ ] C·∫≠p nh·∫≠t `vertex.ai.project.id` trong `application.properties`
- [ ] Ch·∫°y `mvn clean install`
- [ ] Test API v·ªõi Postman/curl
- [ ] Test tr√™n frontend (AIChatbox)

---

## üÜò H·ªó tr·ª£

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ:
1. Ki·ªÉm tra logs trong terminal/console
2. Verify `GOOGLE_APPLICATION_CREDENTIALS` ƒë√£ set ƒë√∫ng
3. Verify Service Account c√≥ ƒë·ªß quy·ªÅn
4. Ki·ªÉm tra billing account ƒë√£ ƒë∆∞·ª£c enable
5. Tham kh·∫£o [Vertex AI Troubleshooting](https://cloud.google.com/vertex-ai/docs/troubleshooting)

---

**Ch√∫c b·∫°n setup th√†nh c√¥ng! üéâ**
